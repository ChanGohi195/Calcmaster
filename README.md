# CalcMaster - 要件定義書

## 1. 概要

『CalcMaster』は、低学年の児童を対象とした、足し算・引き算に特化したタブレット向けWeb学習アプリケーションです。九九練習アプリの「ゲーミフィケーション × データ駆動の学習サイクル」の思想を継承し、直感的な難易度調整、個別最適化された苦手克服機能、そして教師向けの高度な分析機能を提供します。

**目標:** 児童が楽しみながら計算能力を向上させ、教師がその進捗を的確に把握し、指導の質を高めることを支援します。

## 2. 技術スタックと構成

本プロジェクトは、すべての技術スタックを無料で構成します。

- **フロントエンド:** React (Vite)
- **ホスティング:** Vercel
- **バックエンド & データベース:** Supabase
  - **データ分析処理:** Supabase Edge Functions (サーバーサイドで実行)

## 3. 機能要件

### 3.1. 児童向け機能

#### 3.1.1. ユーザー登録・ログイン
- **方式:** 児童が初回プレイ時に「ニックネーム」と「PIN（4桁の数字など）」を設定するだけで利用開始できる、シンプルな自己登録方式。

#### 3.1.2. 学習モード
1.  **フリー練習モード**
    - **難易度設定:**
      - **数値範囲:** 「最初の数」と「次の数」の範囲（1〜20がコア）を、それぞれ独立したスライダーで直感的に調整可能。
      - **演算子:** 「たし算」「ひき算」を選択可能。
      - **パターン:** 「繰り上がり」「繰り下がり」の有無をボタンでON/OFF可能。
2.  **苦手集中モード**
    - **AI提案 (ルールベース):** 学習ログを分析し、「`8+7`のような問題が苦手みたいだよ」といった具体的な問題を自動で提案。
    - **手動選択:** 「繰り下がりのある引き算」のように、児童や教師が特定のテーマを選んで練習可能。

#### 3.1.3. ゲーミフィケーション
- **スコア:** 正答や回答時間に応じてスコアを付与。
- **コンボ:** 連続正解でコンボが発生し、スコアが上昇。
- **タイマー:** 制限時間内にどれだけ解けるかに挑戦するモード。
- **レベル/バッジ:** 累計スコアや特定条件の達成でレベルアップしたり、バッジを獲得したりする。
- **リーダーボード:** クラス内のランキングを表示。

### 3.2. 教師・管理者向け機能

#### 3.2.1. ユーザー管理
- **方式:** 教師用管理画面から、児童アカウントの一括登録、編集、削除が可能。児童が自己登録したアカウントをクラスに紐付けることもできる。

#### 3.2.2. 分析ダッシュボード
- **概要:** クラス全体の正答率、平均回答時間、進捗状況をグラフで可視化。
- **詳細分析:**
  - **苦手問題リスト:** クラス全体で正答率が低い問題トップ10を表示。
  - **苦手パターン抽出:** 「繰り上がり」「繰り下がり」など、つまずきの原因となっているパターンを自動で分析。
  - **加数・減数ごとの分析:** 「+8が苦手」「-7に時間がかかる」など、特定の数字に対する正答率と回答時間を算出し、リスト表示。

## 4. セキュリティ要件 (Möbiusの教訓)

1.  **安全なAPI認証:** 管理機能APIは、教師アカウントのJWT認証を必須とする。
2.  **機密情報の安全な管理:** APIキーやDB接続情報などは、SupabaseやVercelの環境変数で管理し、コードリポジトリには含めない。
3.  **安全なアーキテクチャ:** クライアントから管理用APIを直接呼び出すことを禁止し、必ず認証を経たサーバーサイド（Edge Function）経由で実行する。
4.  **検証用環境の分離:** GitHubの`develop`ブランチを検証環境、`main`ブランチを本番環境へ自動デプロイするCI/CDパイプラインを構築する。

## 5. 開発セットアップ

### 5.1. 前提条件

- Node.js 18以上
- Supabaseアカウント（無料）

### 5.2. Supabaseプロジェクトのセットアップ

1. [Supabase](https://supabase.com)でアカウントを作成し、新しいプロジェクトを作成
2. プロジェクトのダッシュボードから「SQL Editor」を開く
3. `supabase/migrations/20250122000000_initial_schema.sql`の内容をコピーして実行
4. プロジェクトの設定から以下の情報を取得:
   - Project URL（例: `https://xxxxx.supabase.co`）
   - Anon/Public Key（例: `eyJhbGc...`）

### 5.3. ローカル開発環境のセットアップ

```bash
# 1. リポジトリをクローン
git clone https://github.com/changohi195/CalcMaster.git
cd CalcMaster

# 2. 依存関係をインストール
npm install

# 3. Webアプリケーションのディレクトリに移動
cd apps/web

# 4. 環境変数ファイルを作成
cp .env.example .env

# 5. .envファイルを編集してSupabaseの情報を設定
# VITE_SUPABASE_URL=your_supabase_project_url
# VITE_SUPABASE_ANON_KEY=your_supabase_anon_key

# 6. 開発サーバーを起動
npm run dev
```

開発サーバーが起動したら、ブラウザで http://localhost:5173 にアクセスしてアプリケーションを確認できます。

### 5.4. トラブルシューティング

#### Supabaseへの接続エラー
- `.env`ファイルに正しいURLとキーが設定されているか確認
- Supabaseプロジェクトが正しく作成されているか確認
- マイグレーションSQLが正しく実行されているか確認

#### 認証エラー
- ブラウザのローカルストレージをクリアして再度ログイン
- PINは4桁の数字で入力

## 6. プロジェクト構成

```
CalcMaster/
├── apps/
│   └── web/                    # Webアプリケーション
│       ├── src/
│       │   ├── components/     # 再利用可能なコンポーネント
│       │   ├── contexts/       # Reactコンテキスト
│       │   ├── lib/            # ユーティリティとロジック
│       │   ├── pages/          # ページコンポーネント
│       │   └── types/          # TypeScript型定義
│       └── ...
├── supabase/
│   └── migrations/             # データベースマイグレーション
└── README.md
```

## 7. 実装済み機能

- ✅ ユーザー登録・ログイン（ニックネーム + PIN）
- ✅ フリー練習モード
  - スライダーによる柔軟な難易度設定
  - 足し算・引き算の切り替え
  - 繰り上がり・繰り下がりの制御
- ✅ ゲーミフィケーション機能
  - リアルタイムスコア
  - コンボシステム
  - タイマー
- ✅ 学習ログの自動記録
- ✅ ルールベースの苦手分析エンジン

## 8. 今後の実装予定

- 🚧 苦手集中モード（AIサジェスト）
- 🚧 教師向け分析ダッシュボード
- 🚧 クラス管理機能
- 🚧 バッジ・レベルシステム
- 🚧 リーダーボード
